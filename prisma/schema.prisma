generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id String @id @default(uuid())

  usernameHash  String @unique
  passwordProof String
  masterKeyPK   String

  sessions                             Session[]
  correspondenceRequests               ServiceCorrespondenceRequest[]
  individualLv1BCorrespondenceRequests IndividualLv1BCorrespondenceRequest[]
  individualLv2BCorrespondenceRequests IndividualLv2BCorrespondenceRequest[]
  individualLv2ACorrespondenceRequests IndividualLv2ACorrespondenceRequest[]
  individualLv3ACorrespondenceRequests IndividualLv3ACorrespondenceRequest[]
  correspondences                      Correspondence[]
  exchanges                            Exchange[]
  messages                             Message[]
  notifications                        Notification[]
  files                                File[]
}

model ServiceCorrespondenceRequest {
  id        String @id @default(uuid())
  forUser   User   @relation(fields: [forUserId], references: [id], onDelete: Cascade)
  forUserId String

  serverUrl               String
  correspondenceRequestId String @unique // Generated by server

  correspondenceKeySPK  String
  correspondenceKeyMK   String
  correspondenceKeyMKIV String
}

model IndividualLv1BCorrespondenceRequest {
  id        String @id @default(uuid())
  forUser   User   @relation(fields: [forUserId], references: [id], onDelete: Cascade)
  forUserId String

  correspondenceCode   String @unique // Generated by server
  correspondenceInitID String @unique // Generated by server

  correspondenceInitPublicKey String

  correspondenceInitPrivateKeyMK   String
  correspondenceInitPrivateKeyMKIV String

  into IndividualLv2BCorrespondenceRequest?
}

model IndividualLv2BCorrespondenceRequest {
  id        String @id @default(uuid())
  forUser   User   @relation(fields: [forUserId], references: [id], onDelete: Cascade)
  forUserId String

  from   IndividualLv1BCorrespondenceRequest @relation(fields: [fromId], references: [id])
  fromId String                              @unique

  serverUrl String

  userDisplayNameCK   String
  userDisplayNameCKIV String

  correspondenceKeyCIPK String
}

model IndividualLv2ACorrespondenceRequest {
  id        String @id @default(uuid())
  forUser   User   @relation(fields: [forUserId], references: [id], onDelete: Cascade)
  forUserId String

  serverUrl String

  correspondenceInitID String @unique // Generated by server

  correspondenceKeyMK   String
  correspondenceKeyMKIV String

  into IndividualLv3ACorrespondenceRequest?
}

model IndividualLv3ACorrespondenceRequest {
  id        String @id @default(uuid())
  forUser   User   @relation(fields: [forUserId], references: [id], onDelete: Cascade)
  forUserId String

  from   IndividualLv2ACorrespondenceRequest @relation(fields: [fromId], references: [id], onDelete: Cascade)
  fromId String                              @unique

  userDisplayNameCK   String
  userDisplayNameCKIV String
}

model Correspondence {
  id String @id @default(uuid())

  forUser   User   @relation(fields: [forUserId], references: [id], onDelete: Cascade)
  forUserId String

  accessToken String @unique // Generated by server

  isService   Boolean
  isInitiator Boolean

  // TODO: permissions

  correspondenceKeyMK   String
  correspondenceKeyMKIV String
  userDisplayNameCK     String
  userDisplayNameCKIV   String

  exchanges Exchange[]
}

model Exchange {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  correspondence   Correspondence @relation(fields: [correspondenceId], references: [id], onDelete: Cascade)
  correspondenceId String
}

model Message {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  isImportant Boolean

  titleCK   String
  titleCKIV String

  categoryCK   String
  categoryCKID String

  bodyCK   String
  bodyCKIV String

  files File[]
}

model Notification {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  isImportant Boolean

  titleCK   String
  titleCKIV String

  categoryCK   String
  categoryCKID String

  bodyCK   String
  bodyCKIV String

  files File[]
}

model File {
  id      String @id @default(uuid())
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId String

  contentCK   String
  contentCKIV String

  fromMessage   Message? @relation(fields: [fromMessageID], references: [id], onDelete: Cascade)
  fromMessageID String?

  fromNotification   Notification? @relation(fields: [fromNotificationId], references: [id], onDelete: Cascade)
  fromNotificationId String?
}

model Session {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  accessToken String @unique
}
